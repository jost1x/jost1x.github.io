---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";

const projects = (await getCollection("projects")).sort(
  (a, b) => b.data.startDate.getTime() - a.data.startDate.getTime(),
);

const formatYear = (date) => date.getFullYear();

const images = import.meta.glob("/src/assets/*.{png,jpg,jpeg,webp,avif}", {
  eager: true,
});

const getImageByPath = (path) =>
  (images[`/src/assets/${path}`] as any)?.default;

// solo 2 proyectos grandes
let bigUsed = 0;
const isBig = (project) => {
  if (!project.data.image) return false;
  if (bigUsed < 2) {
    bigUsed++;
    return true;
  }
  return false;
};
---

<section id="projects" class="px-6 py-32">
  <div class="mx-auto max-w-5xl">
    <p class="text-primary mb-4 text-xs tracking-[0.2em] uppercase">
      Proyectos
    </p>

    <h2 class="text-foreground mb-12 text-2xl font-medium md:text-3xl">
      Trabajos destacados
    </h2>

    <!-- Bento grid -->
    <div class="grid auto-rows-[150px] grid-cols-1 gap-4 md:grid-cols-4">
      {
        projects.map((project) => {
          const big = isBig(project);
          const hasImage = !!project.data.image;

          return (
            <article
              class={`group hover:border-primary/20 relative overflow-hidden rounded-2xl border border-white/6 bg-white/3 backdrop-blur-md transition-all duration-300 hover:bg-white/6 ${
                big
                  ? "md:col-span-2 md:row-span-2"
                  : "md:col-span-1 md:row-span-1"
              }`}
            >
              {big && hasImage && (
                <div class="relative h-full w-full">
                  <Image
                    src={getImageByPath(project.data.image)}
                    alt={project.data.title}
                    class="absolute inset-0 h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />

                  <div class="absolute inset-0 bg-linear-to-t from-black/80 via-black/40 to-transparent" />

                  <div class="relative z-10 flex h-full flex-col justify-end p-6">
                    <h3 class="mb-1 font-medium text-white">
                      {project.data.title}
                    </h3>

                    <p class="mb-2 text-xs text-white/70">
                      {project.data.category} ·{" "}
                      {formatYear(project.data.startDate)}
                      {project.data.endDate
                        ? ` – ${formatYear(project.data.endDate)}`
                        : " – Act"}
                    </p>

                    <p class="line-clamp-2 max-w-[90%] text-sm text-white/80">
                      {project.data.summary}
                    </p>
                  </div>
                </div>
              )}

              {/* ===== PROYECTO PEQUEÑO ===== */}
              {!big && (
                <div class="flex h-full flex-col justify-between p-4">
                  <div>
                    <h3 class="text-foreground mb-1 text-sm font-medium">
                      {project.data.title}
                    </h3>

                    <p class="text-muted-foreground mb-2 text-xs">
                      {project.data.category} ·{" "}
                      {formatYear(project.data.startDate)}
                    </p>

                    <p class="text-muted-foreground line-clamp-2 text-xs">
                      {project.data.summary}
                    </p>
                  </div>

                  <div class="mt-3 flex flex-wrap gap-1">
                    {project.data.tags.slice(0, 2).map((tag) => (
                      <span class="text-muted-foreground rounded border border-white/10 bg-white/5 px-2 py-0.5 text-[10px]">
                        {tag}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </article>
          );
        })
      }
    </div>
  </div>
</section>
