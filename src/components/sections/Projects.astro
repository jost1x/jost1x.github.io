---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";

const projects = (await getCollection("projects")).sort(
  (a, b) => b.data.startDate.getTime() - a.data.startDate.getTime()
);

const formatYear = (date) => date.getFullYear();

const images = import.meta.glob(
  "/src/assets/*.{png,jpg,jpeg,webp,avif}",
  { eager: true }
);

const getImageByPath = (path) =>
  (images[`/src/assets/${path}`] as any)?.default;


  
// solo 2 proyectos grandes
let bigUsed = 0;
const isBig = (project) => {
  if (!project.data.image) return false;
  if (bigUsed < 2) {
    bigUsed++;
    return true;
  }
  return false;
};
---

<section id="projects" class="py-32 px-6">
  <div class="max-w-6xl mx-auto">
    <p class="text-primary text-xs tracking-[0.2em] uppercase mb-4">
      Proyectos
    </p>

    <h2 class="text-2xl md:text-3xl font-medium text-foreground mb-12">
      Trabajos destacados
    </h2>

    <!-- Bento grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 auto-rows-[220px] gap-4">
      {projects.map((project) => {
        const big = isBig(project);
        const hasImage = !!project.data.image;

        return (
          <article
            class={`group relative rounded-2xl overflow-hidden border border-white/6 bg-white/3 backdrop-blur-md transition-all duration-300 hover:border-primary/20 
            ${
              big
                ? "md:col-span-2 md:row-span-2"
                : "md:col-span-1 md:row-span-1"
            }`}
          >
            {/* ===== PROYECTO GRANDE ===== */}
            {big && hasImage && (
              <div class="relative h-full w-full">
                <Image
                  src={getImageByPath(project.data.image)}
                  alt={project.data.title}
                  class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                />

                <!-- Gradient overlay -->
                <div class="absolute inset-0 bg-linear-to-t from-black/80 via-black/40 to-transparent" />

                <!-- Content -->
                <div class="relative z-10 p-6 h-full flex flex-col justify-end">
                  <h3 class="text-white font-medium mb-1">
                    {project.data.title}
                  </h3>

                  <p class="text-white/70 text-xs mb-2">
                    {project.data.category} · {formatYear(project.data.startDate)}
                    {project.data.endDate
                      ? ` – ${formatYear(project.data.endDate)}`
                      : " – Act"}
                  </p>

                  <p class="text-white/80 text-sm line-clamp-2 max-w-[90%]">
                    {project.data.summary}
                  </p>
                </div>
              </div>
            )}

            {/* ===== PROYECTO PEQUEÑO ===== */}
            {!big && (
              <div class="p-4 h-full flex flex-col justify-between">
                <div>
                  <h3 class="text-foreground font-medium mb-1 text-sm">
                    {project.data.title}
                  </h3>

                  <p class="text-muted-foreground text-xs mb-2">
                    {project.data.category} · {formatYear(project.data.startDate)}
                  </p>

                  <p class="text-muted-foreground text-xs line-clamp-2">
                    {project.data.summary}
                  </p>
                </div>

                <div class="flex flex-wrap gap-1 mt-3">
                  {project.data.tags.slice(0, 2).map((tag) => (
                    <span class="px-2 py-0.5 text-[10px] rounded bg-white/5 border border-white/10 text-muted-foreground">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </article>
        );
      })}
    </div>
  </div>
</section>
